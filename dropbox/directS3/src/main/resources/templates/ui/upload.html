<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Upload File</title>
  <style>
    body { font-size: 16px; font-family: Arial, sans-serif; padding: 20px; }
    h1 { font-size: 28px; }
    button { font-size: 16px; padding: 10px 20px; }
    input[type="file"] { font-size: 16px; }
    a { color: #0066cc; text-decoration: none; font-size: 16px; }
  </style>
 </head>
<body>
  <h1>Upload</h1>
  <input type="file" id="fileInput" />
  <button id="uploadBtn">Upload</button>
  <p><a th:href="@{/ui}">Back</a></p>

  <script>
    async function initializeUpload(file) {
      console.log('Initializing upload for:', file.name);
      const initResp = await fetch('/api/files/upload/init', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          fileName: file.name,
          size: file.size,
          contentType: file.type
        })
      });
      if (!initResp.ok) {
        throw new Error('Failed to initialize upload: ' + initResp.status);
      }
      const body = await initResp.json();
      console.log('Got presigned URL:', body.uploadUrl);
      return { uploadUrl: body.uploadUrl, fileId: body.fileId };
    }

    async function uploadToS3(uploadUrl, file) {
      console.log('Uploading to S3...');
      const putResp = await fetch(uploadUrl, { method: 'PUT', body: file });
      console.log('S3 PUT response status:', putResp.status);
      if (!putResp.ok) {
        const errorText = await putResp.text();
        console.error('Upload failed:', errorText);
        throw new Error('Upload failed: ' + putResp.status + ' - ' + errorText);
      }
      console.log('Upload successful');
    }

    async function handleUpload() {
      try {
        const input = document.getElementById('fileInput');
        if (!input.files.length) {
          alert('Choose a file');
          return;
        }
        const file = input.files[0];

        const { uploadUrl, fileId } = await initializeUpload(file);
        await uploadToS3(uploadUrl, file);

        console.log('Redirecting to list...');
        window.location = '/ui';
      } catch (error) {
        console.error('Upload error:', error);
        alert('Upload error: ' + error.message);
      }
    }

    document.getElementById('uploadBtn').addEventListener('click', handleUpload);
  </script>
</body>
</html>
